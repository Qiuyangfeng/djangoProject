{% extends 'layout.html' %}
{% block content %}
    <button id="btnAdd" type="button" class="btn btn-success">新建账号</button>
    <a class="btn btn-success" href="/account/file/excel/">上传xlsx</a>
    <button type="button" class="btn btn-primary" data-toggle="modal" onclick="UploadEvent()">上传模板</button>
    <div style="float: right;width: 300px">
        <form method="get">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="搜索" name="search" value="{{ search_data }}"/>
                <span class="input-group-btn">
                <button class="btn btn-default" type="submit">
                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                </button>
                </span>
            </div>
        </form>
    </div>
    <div class="bs-example" data-example-id="hoverable-table">
        <table class="table table-hover">
            <thead>
            <tr>
                {% for key in key_list %}
                    {% if key != 'id' %}
                        <th>{{ key }}</th>
                    {% endif %}
                {% endfor %}
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for data in page_obj %}
                <tr>
                    <td>{{ data.name }}</td>
                    <td>{{ data.username }}</td>
                    <td>******</td>
                    <td>{{ data.note }}</td>
                    <td>
                        <a uid="{{ data.id }}" class="btn btn-primary btn-xs btn-edit">编辑</a>
                        <a uid="{{ data.id }}" class="btn btn-danger btn-xs btn-delete">删除</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- 添加/编辑订单Modal -->
    <div class="modal fade" id="modalAddEdit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="modalAddEditLabel">title</h4>
                </div>
                <div class="modal-body">
                    <form id="formAddEdit" novalidate>
                        <div class="clearfix">
                            {% for i in form %}
                                <div class="col-xs-12">
                                    <div class="form-group" style="position: relative;margin-bottom: 20px">
                                        <label>{{ i.label }}</label>
                                        {{ i }}
                                        <span class="error-msg" style="color: red;position: absolute"></span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button id="btnSave" type="button" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 删除订单Modal -->
    <div class="modal fade" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="alert alert-danger alert-dismissible fade in" role="alert">
                <h4>是否删除该账号？</h4>
                <p>删除后，相关账号将会消失！</p>
                <p style="text-align: right;">
                    <button id="btnConfirmDelete" type="button" class="btn btn-danger">确定</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                </p>
            </div>
        </div>
    </div>
    <!-- 上传Small modal -->
    <div class="modal fade" id="modalUpload" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <p>
                    <input type="file" class="form-control" name="upload" id="file_uploads" required/>
                </p>
                <button id="btnUploadExcel" class="btn btn-info form-control" type="submit" onclick="uploads()"
                        value="submit">上传
                </button>
            </div>
        </div>
    </div>
    <div class="pagination">
    <span class="step-links">
    <nav aria-label="Page navigation">
    <ul class="pagination">
    <li>
        {% if page_obj.has_previous %}
            <a href="?page=1&search={{ search_data }}">&laquo; 首页</a>
            <a href="?page={{ page_obj.previous_page_number }}&search={{ search_data }}">上一页</a>
        {% endif %}

        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
        <a href="?page={{ page_obj.start_index }}&search={{ search_data }}">{{ page_obj.number }}</a>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&search={{ search_data }}">下一页</a>
            <a href="?page={{ page_obj.paginator.num_pages }}&search={{ search_data }}">尾页 &raquo;</a>
        {% endif %}
    </li>
    </ul>
    </nav>
    </span>
    </div>
{% endblock %}
{% block js %}
    <script type="text/javascript">
        var DELETE_ID;
        var EDIT_ID;
        $(function () {
            bindBtnAddEvent();
            bindBtnEditEvent();
            bindBtnSaveEvent();
            bindBtnDeleteEvent();
            bindBtnConfirmDeleteEvent();
        })

        function bindBtnAddEvent() {
            $("#btnAdd").click(function () {
                // 将正在编辑的ID设置为空
                EDIT_ID = undefined;
                //清空对话框内容
                $("#formAddEdit")[0].reset();
                //修改对话框标题
                $("#modalAddEditLabel").text("新建");
                //点击新建按钮，显示对话框
                $('#modalAddEdit').modal('show');
            });
        }

        function bindBtnEditEvent() {
            $(".btn-edit").click(function () {
                //清空对话框内容
                $("#formAddEdit")[0].reset();
                var uid = $(this).attr("uid");
                EDIT_ID = uid;
                //发送ajax去后端获取当前行的数据  /account/detail/?uid=123
                $.ajax({
                    url: "/account/detail/",
                    type: "get",
                    data: {
                        uid: uid
                    },
                    dataType: "JSON",
                    success: function (res) {
                        if (res.status) {
                            //将数据赋值到标签中
                            $.each(res.data, function (name, value) {
                                $("#id_" + name).val(value)
                            })
                            //修改对话框标题
                            $("#modalAddEditLabel").text("编辑")
                            //点击编辑按钮，显示对话框
                            $('#modalAddEdit').modal('show');
                        } else {
                            alert(res.error);
                        }
                    }

                })
            })
        }

        function bindBtnSaveEvent() {
            $("#btnSave").click(function () {
                //清除错误信息
                $(".error-msg").empty();
                if (EDIT_ID) {
                    //编辑
                    doEdit();
                } else {
                    //添加
                    doAdd();
                }
            });
        }

        function doAdd() {
            //点击保存按钮，发生请求
            $.ajax({
                url: "add/",
                type: "post",
                data: $("#formAddEdit").serialize(),
                dataType: 'JSON',
                success: function (res) {
                    if (res.status) {
                        //alert("创建成功");
                        //清空表单 $("#formAdd")是jQuery对象 -> $("#formAdd")[0] DOM对象
                        //$("#formAdd")[0].reset();
                        //隐藏对话框
                        //$('#myModal').modal('hide');
                        //刷新页面
                        location.reload();
                    } else {
                        // 把错误信息显示在对话框中
                        $.each(res.error, function (name, errorList) {
                            $("#id_" + name).next().text(errorList[0]);
                        })
                    }
                }
            })
        }

        function doEdit() {
            //点击保存按钮，发生请求  /order/edit/?uid=123
            $.ajax({
                url: "/account/edit/" + "?uid=" + EDIT_ID,
                type: "post",
                data: $("#formAddEdit").serialize(),
                dataType: 'JSON',
                success: function (res) {
                    if (res.status) {
                        //alert("创建成功");
                        //清空表单 $("#formAdd")是jQuery对象 -> $("#formAdd")[0] DOM对象
                        //$("#formAdd")[0].reset();
                        //隐藏对话框
                        //$('#myModal').modal('hide');
                        //刷新页面
                        location.reload();
                    } else {
                        if (res.tips) {
                            alert(res.tips);
                        } else {
                            // 把错误信息显示在对话框中
                            $.each(res.error, function (name, errorList) {
                                $("#id_" + name).next().text(errorList[0]);
                            })
                        }
                    }
                }
            })
        }

        function bindBtnDeleteEvent() {
            $(".btn-delete").click(function () {
                //点击删除按钮，显示对话框
                $('#modalDelete').modal('show');
                DELETE_ID = $(this).attr("uid")
                //console.log(DELETE_ID);
            });
        }

        function bindBtnConfirmDeleteEvent() {
            $("#btnConfirmDelete").click(function () {
                //点击确定删除按钮，发送ajax请求删除数据
                $.ajax({
                    url: "/account/delete/",
                    type: "get",
                    data: {
                        uid: DELETE_ID
                    },
                    dataType: "JSON",
                    success: function (res) {
                        if (res.status) {
                            //隐藏删除框
                            //$('#deleteModal').modal('hide');
                            //删除当前行js
                            //$("tr[uid='" + DELETE_ID + "']").remove()
                            //删除成功信息
                            //alert(res.msg);
                            DELETE_ID = 0
                            //刷新页面
                            location.reload()

                        } else {
                            //删除失败
                            alert(res.error)
                        }
                    }
                })
            });
        }

        function UploadEvent() {
            $('#modalUpload').modal('show');
        }

        function uploads() {
            const form_data = new FormData();
            form_data.append('files', $('#file_uploads')[0].files[0]);
            $.ajax({
                type: 'post',
                contentType: false,
                processData: false,
                data: form_data,
                success: function (callback) {
                    alert('上传完成!')
                    location.reload();
                }
            })
        }

    </script>
{% endblock %}
